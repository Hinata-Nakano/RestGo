#!/bin/sh
# Pre-commit hook for Go files
# Runs gofmt and go vet checks

# ã‚¨ãƒ©ãƒ¼ãƒ•ãƒ©ã‚°
HAS_ERRORS=0

# ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã•ã‚ŒãŸGoãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
get_staged_go_files() {
    git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true
}

# gofmtãƒã‚§ãƒƒã‚¯ã¨è‡ªå‹•ä¿®æ­£
check_gofmt() {
    local files="$1"
    
    if [ -z "$files" ]; then
        return 0
    fi
    
    echo "ğŸ” gofmtãƒã‚§ãƒƒã‚¯ä¸­..."
    local unformatted=$(echo "$files" | xargs gofmt -l 2>/dev/null || true)
    
    if [ -n "$unformatted" ]; then
        echo "ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“:"
        echo "$unformatted"
        echo ""
        
        # è‡ªå‹•ä¿®æ­£
        echo "$unformatted" | xargs gofmt -w
        echo "$unformatted" | xargs git add
        echo "âœ“ ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’è‡ªå‹•ä¿®æ­£ã—ã¾ã—ãŸ"
        echo "å†åº¦addã—ã¦commitã—ã¦ãã ã•ã„"
        HAS_ERRORS=1
        return 1
    fi
    
    echo "âœ“ gofmtãƒã‚§ãƒƒã‚¯å®Œäº†"
    return 0
}

# go vetãƒã‚§ãƒƒã‚¯
check_govet() {
    local files="$1"
    
    if [ -z "$files" ]; then
        return 0
    fi
    
    echo "ğŸ” go vetãƒã‚§ãƒƒã‚¯ä¸­..."
    
    # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å«ã‚€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’å–å¾—
    local packages=$(echo "$files" | sed 's|/[^/]*$||' | sort -u | sed 's|^|./|')
    
    for pkg in $packages; do
        if [ -d "$pkg" ]; then
            # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã—ã¦go vetã‚’å®Ÿè¡Œï¼ˆgo.modã‚’è¦‹ã¤ã‘ã‚‹ãŸã‚ï¼‰
            local vet_output
            if ! vet_output=$(cd "$pkg" && go vet . 2>&1); then
                echo "âœ— go vetã§å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ: $pkg"
                echo "$vet_output"
                HAS_ERRORS=1
            fi
        fi
    done
    
    if [ $HAS_ERRORS -eq 0 ]; then
        echo "âœ“ go vetãƒã‚§ãƒƒã‚¯å®Œäº†"
    fi
    
    return $HAS_ERRORS
}

# ãƒ¡ã‚¤ãƒ³å‡¦ç†
main() {
    local files=$(get_staged_go_files)
    
    if [ -z "$files" ]; then
        echo "Goãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“"
        exit 0
    fi
    
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "Pre-commit checks for Go files"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    
    # gofmtãƒã‚§ãƒƒã‚¯ï¼ˆè‡ªå‹•ä¿®æ­£ã‚ã‚Šï¼‰
    check_gofmt "$files"
    local fmt_result=$?
    
    # go vetãƒã‚§ãƒƒã‚¯ï¼ˆã‚¨ãƒ©ãƒ¼æ™‚ã¯ä¸­æ–­ã—ãªã„ï¼‰
    check_govet "$files"
    local vet_result=$?
    
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    if [ $fmt_result -ne 0 ] || [ $vet_result -ne 0 ]; then
        echo "âœ— Pre-commitãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸ"
        exit 1
    fi
    
    echo "âœ“ ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ã‚’ãƒ‘ã‚¹ã—ã¾ã—ãŸ"
    exit 0
}

main